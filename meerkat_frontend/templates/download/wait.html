{% extends 'base.html' %}
{% block menu %}
{% endblock menu %}

{% block body %}
<!-- CONTENT -->
<div class="container page-content">
	<div class="top-bar row">
		<div class="tab-title less-padding-col">
			{{_('Download Data') }}
		</div>
		<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box ">
			{{ _('Date not loaded.') }}
		</div>
	</div>
	<div id="page-content-wrapper">
	    <div class="row">
                <div class col-md-12>
	            <h4> {{ _('Your data set is being prepared') }} <h4>
                        <div id="spinner">
                            <img class='spinner' src='{{url_for('static', filename='img/spinner.gif')}}' ></img></div>
                        <p> Current Status: </p>
                        <span id="status"> </span>
		</div>
		</div>
	</div>
</div>
{% endblock body %}

{% block pageJS %}

<script type="text/javascript" >
 var config = {{content|tojson|safe}};
 var api_root = "{{config['EXTERNAL_API_ROOT']}}";
 var week = {{week.epi_week}};
 $("#epi-week-title").html( i18n.gettext("Week")+" "+get_epi_week() + " Â· " + get_date() );
 url ='{{api_url|safe}}';
 var uuid = "";
 interval = ""
 console.log(url)
 function check_status(){
     $.getJSON(api_root + "/export/get_status/" + uuid, function( data ){
         if(data){
             console.log(data);
             if(data.status == 1){
                 if(data.success == 1){

                     t = i18n.gettext("Data set was sucesfully generated. Download ") + '<a href="' + api_root + "/export/get/" + uuid +'">' + i18n.gettext("here") + '</a>'
                     $("#spinner").html(t);
                     $("#status").html("Finished");

                 }else{
                     t = i18n.gettext("Data set generation was unsucesfull, please try again later")
                         $("#spinner").html(t);
                     $("#status").html("Finished");
                 }
                 clearInterval(interval)
             }else{
                 t = i18n.gettext("Dataset is still being prepared, please wait.")
                 $("#status").html(t)
             }
         
         }
     });
 }

 $.getJSON(url, function( data ){
     uuid = data;

     $("#status").html(i18n.gettext("Preparation of data set has started. Please note that this can take some time."))
         
         interval = setInterval(function() {
             check_status()
         }, 5000);
     });

 
</script>

{% endblock pageJS %}
