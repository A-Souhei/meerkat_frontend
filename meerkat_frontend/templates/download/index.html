{% extends 'base.html' %}

{% block menu %}
<ul class="nav navbar-nav">
  <li><a href="#" >Dashboard</a></li>
  <li><a href="/reports/" >Reports</a></li>
  <li><a href="/messaging/" >Notifications</a></li>
  <li><a href="#" >Explore Data</a></li>
  <li class="active"><a href="/download/" >Download Data</a></li>
  <li><a href="/" >Log out</a></li>
</ul>
{% endblock %}

{% block body %}
<!-- CONTENT -->
<div class="container page-content">
	<div class="top-bar row">
		<div class="tab-title less-padding-col">
			Download Data 
		</div>
		<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box ">
			Date not loaded.
		</div>
	</div>
	<div id="page-content-wrapper">
		<div class="row">
			<div class="col-xs-12 less-padding-col">
				<div class="box chartBox">
					<div class="chartBox__heading">
						Select the data you wish to download
					</div>
					<div class="chartBox__content" >    
						<div class="intro">
                        	{{content.intro}}
						</div>
						<div class="breaker"></div>
						<div class="row">
							<form id="data-download" 
							      class="col-sm-offset-1 col-md-offset-2 col-xs-12 col-sm-8 col-md-6">
								<div class="row">
									<label class="col-xs-12 no-padding-col">
										Which form would you like to download?
									</label>
									<select class="col-sm-offset-3" id="form-selector"></select>
								</div>
								<div class="row check">
									<input id="show-attributes" type="checkbox" checked>
									<label>Just download the default attributes.</label>
								</div>
								<div id="attribute-selector" style="display:none;" class="row box chartBox">
									<div class="chartBox__heading">
										Avilable Attributes
										<div class="pull-right">
											<a href="#" onclick='selectAll(); return false;'>
												All
											</a> /
											<a href="#" onclick='selectNone(); return false;'>
												None
											</a> /
											<a href="#" onclick='selectDefault(); return false;'>
												Default
											</a>
										</div>
									</div>
									<div class="chartBox__content"></div>
								</div>
								<div class="row">
									<input type="submit" 
									       class="submit btn btn-default btn-lg col-sm-offset-3" 
									       value="Download">
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock body %}

{% block footer %}
<div class="container">
	<div class="footer__label pull-left col-xs-12 col-sm-6 col-md-5 less-padding-col">
		<p class="footer__title">Meerkat Health Surveillance</p>
		<p>Working with our partners:</p> 
		<ul class="footer__supporters" >
			{% for partner in content.footer.partners %}
				<li>{{partner}}</li>
			{% endfor %} 
		</ul>
		<p>For more information, please e-mail: {{content.footer.email|safe}} </p>
	</div>
	<div class="footer__logos pull-right col-xs-12 col-sm-6 col-md-7 less-padding-col">
		<img src="{{ url_for('static', filename='img/homepage/' + content.footer.logos.who) }}" id="whoLogo" ></img> 
		<img src="{{ url_for('static', filename='img/homepage/' + content.footer.logos.country_partner) }}"
		     id="countryLogo" ></img> 
		{% for logo in content.footer.logos.partners %}
			<img src="{{ url_for('static', filename='img/homepage/' + logo) }}" ></img> 
		{% endfor %} 
	</div>
</div>
{% endblock footer %}

{% block pageJS %}

<script type="text/javascript" >
  
var config = {{content|tojson|safe}};
var api_root = "{{config['EXTERNAL_API_ROOT']}}";
var week = {{week.epi_week}};

$("#epi-week-title").html( "Week "+get_epi_week() + " Â· " + get_date() );

$.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
	options.data = $.param($.extend(originalOptions.data, { api_key: config.api_key })) // 
});

//Check that at least one checkbox is clicked
function checkSelected( ) {

	checked = $('input[name=attributes]:checked').length;

	if(!checked) {

		boxes = document.getElementsByName('attributes')
		for( var i=0; i<boxes.length; i++ ){
			boxes[i].setCustomValidity('You must tick at least one checkbox.');
		}

		return false;

	}else{

		boxes = document.getElementsByName('attributes')
		for( var i=0; i<boxes.length; i++ ){
			boxes[i].setCustomValidity('');
		}

		return true;

	}
}

function selectAll(){
	$('input[name=attributes]').each(function(){
		this.checked = true;
	});
}

function selectNone(){	
	$('input[name=attributes]').each(function(){
	  this.checked = false;
	});
}

function selectDefault(){

	//Load the default values.
	var defaultAttributes = config.forms[ $('#form-selector').val() ].default;
	console.log(defaultAttributes);
	//If no default values, the default to select all.
	if( defaultAttributes.length == 0 ){

		selectAll();

	//Else just select default fields.
	}else{

		//Uncheck everything
		selectNone();

		//Finally set each default attribute checkbox to checked.
		for( var k in defaultAttributes ){		
		  $("input[value='" + defaultAttributes[k] + "']" ).prop('checked', true); 
		}
	}
}

$.getJSON( api_root+"/export/forms", function( data ){

	var configForms = Object.keys(config.forms);
	var apiForms = Object.keys( data );
	var formSelector = "";

    for( var i in apiForms ){

		formSelector += "<option value='" + apiForms[i] + "'>";
		//If the form is recorded in the config file, use the given "display name".
		if( configForms.indexOf( apiForms[i] ) != -1 ){
			formSelector += config.forms[ apiForms[i] ].name;
		}else{
			formSelector += apiForms[i];		
		}
		formSelector += "</option>"
	}

	$('#form-selector').html(formSelector);

	
	function drawAttributes(form){

		var attrSelector = "";
		var allAttributes = data[form];
		var defaultAttributes = config.forms[form].default;
		
		for( var j in allAttributes ){

			attrSelector += "<div class='check attribute col-xs-12 col-md-6' >"
			attrSelector += "<input type='checkbox' name='attributes' ";
         attrSelector += "onclick='checkSelected();' value='" + allAttributes[j] + "' ";
			attrSelector += "> <label>" + allAttributes[j] + "</label></div>";

		}

		$('#attribute-selector .chartBox__content').html(attrSelector);
		selectDefault();
	}

	drawAttributes( $('#form-selector').val() );

	$('#show-attributes').change( function(){
		if( this.checked ){
			$('#attribute-selector').slideUp();
		}else{
			$('#attribute-selector').slideDown();
		}
		drawAttributes( $('#form-selector').val() );
	});

	$('#form-selector').change( function(){
		drawAttributes( $(this).val() );
	});

	

	$('#data-download').submit( function(event){
		//Validate the form.
		if( checkSelected() ){
			//Assemble the appropriate API call.
			var url = api_root + "/export/form/" + $('#form-selector').val() + "?fields=";
			$('input[name=attributes]:checked').each(function(){
				url += $(this).val() + ",";
			});
		
			url += "&api_key=" + config.api_key;

			window.open( url );
		}else{
			event.preventDefault();
		}
	});

});


</script>

{% endblock pageJS %}
