{% extends 'reports/base.html' %}

{% block title %}{{report.data.project_region|e}} &middot; Weekly Epidemiological Surveillance Report  &middot; Week {{ report.data.epi_week_num }}{% endblock title %}
{% block body %}
<!-- CONTENT -->
<div class="page-content">
<div class="page-header">
  <h2>
    <span 
      class="flag-icon flag-icon-{{report.flag}}"
      style="background-image: url(/static/img/flags/4x3/{{report.flag}}.svg) !important;"
      >
    </span> 
    <span class="hidden-xs">{{report.data.project_region|e}} &middot; </span> Weekly Epidemiological Surveillance Report
    <span class="report-week">
        {{ report.data.start_date|datetime_from_json|datetime('%-d %B %Y') }} - {{ report.data.end_date|datetime_from_json|datetime('%-d %B %Y') }}
    </span>
  </h2>
</div>


<div class="row">
  <!-- Table 1 -->
  <div class="col-sm-12">
    <div class="chart-wrapper">
      <div class="chart-title">Table 1: Summary of Deaths  </div>
      <div class="chart-stage">
        <div class="table-wrapper table-responsive table1-wrapper"></div>
      </div>
    </div>
  </div>
</div>


<div class="row">
  <!-- 2. Mortality -->
  <div class="col-sm-12">
    <div class="chart-wrapper">
      <div class="chart-title">Table 2: Diseases, conditions and events under surveillance</div>
      <div class="chart-stage">
        <div class="col-xs-12 col-md-6 no-padding-col">
          <div class="table-title">2.1 Diseases of epidemic potential</div>
          <div class="table-wrapper table-responsive table21-wrapper"></div>
        </div>
        <div class="col-xs-12 col-md-6">
          <div class="table-title">2.2 Diseases for eradication and elimination</div>
          <div class="table-wrapper table-responsive table22-wrapper"></div>
        </div>
        <div class="col-xs-12 col-md-6">
          <div class="table-title">2.3 Other diseases and events of public health importance</div>
          <div class="table-wrapper table-responsive table23-wrapper"> </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 3. Morbidity -->
<div class="row">
   <div class="col-sm-12">
    <div class="chart-wrapper">
      <div class="chart-title">Table 3: Notifiable Diseases</div>  
        <div class="small-table-wrapper  table-responsive table3-wrapper">
          <!-- TODO: Build Table -->
        </div>
    </div>
  </div>
</div>
</div>


{% endblock body %}


{% block extra_js %}

<script>
//Store the report content from the server.
var content = {{report|tojson|safe}};

//Draw the content using the functions below.
prepareMortData();
drawTable1();
drawTable21();
drawTable22();
drawTable23();
drawTable3();

/*The mortality data value is the number of deaths for a given code.
 *The name of each mortality code is "Deaths [code ID]". We need to match mortality data to
 *code data so this function extracts the corresponding codeID from the name and stores its the data 
 *value under that ID rather than the mortality ID. For example code "mor_1" has name "Deaths icd_17"
 *so this function will restore the "data.mortality.mor_1" as "data.mortality.icd_17".  This makes data
 *much easier to tabulate. */
function prepareMortData(){
  
  var mort_keys = Object.keys(content.deaths);
  for( var i=0; i< mort_keys.length; i++ ){
    var new_key = content.variables[mort_keys[i]].name.replace("Deaths ", "");
    content.deaths[new_key] = content.deaths[mort_keys[i]];
    delete content.deaths[mort_keys[i]];
  }
}

//Draw table 1
function drawTable1(){

  html = "<table class='reports-table centered table table-hover table-condensed'>" +
    "<thead><th class='border-right'></th>";

  mort_keys = Object.keys(content.tot_mortality);
  for( var i=1; i<mort_keys.length; i++ ){
    varTitle = content.variables[mort_keys[i]].name;
    html += "<th>" + varTitle.replace("Deaths ", "") + "</th>";
  }

  html += "<th class='total'>Total</th></thead>" +
    "<tr><td class='border-right key'>Number of deaths</td>";

  for( var i=1; i<mort_keys.length; i++ ){
    datum = content.tot_mortality[ mort_keys[i] ]; 
    html += "<td>" + datum + "</td>";
  }  

  html += "<td class='total'>" + content.tot_mortality[ mort_keys[0] ] + "</td></tr>";    
  html += "<tr><td class='border-right key'>Number of maternal deaths</td>";

  mat_keys = Object.keys(content.mat_mortality);
  for( var i=1; i<mat_keys.length; i++ ){
    datum = content.mat_mortality[ mat_keys[i] ]; 
    html += "<td>" + datum + "</td>";
  }  

  html += "<td class='total'>" + content.mat_mortality[ mat_keys[0] ] + "</td></tr>";
  html += "</table>";

  $('.table1-wrapper').html(html);
}

//Draw table 2.1
function drawTable21(){
  
  var struct = [
    ["Dysentery and bloody diarrhoea", "icd_17"],
    ["Influenza-like illness", "icd_4183"],
    ["Arboviruses", "icd_461"],
    ["Meningitis", "icd_421"],
    ["Plague", "icd_113"],
    ["RDT positive", "epi_4", "highlight no_deaths"],
    ["Bubonic plague", "epi_5", "highlight no_deaths"],
    ["Pulmonary plague", "epi_6", "highlight no_deaths"],
    ["Food Poisoning", "icd_35"],
    ["Seafood poisoning", "icd_9643"],
    ["Acute Jaundice Syndrome", "icd_530"],
    ["Animal Bite", "icd_9225"],
    ["Rabies", "icd_391"]
  ]

  $('.table21-wrapper').html( drawFromStruct(struct) );
}

//Draw table 2.2
function drawTable22(){
  
  var struct = [
    ["Acute flaccid paralysis", "icd_380"],
    ["Neonatal tetanus", "icd_188"],
    ["Measles", "icd_488"],
    ["Leprosy", "icd_168"],
    ["Lymphatic filariasis", "icd_804"],
  ]

  $('.table22-wrapper').html( drawFromStruct(struct) );
}

//Draw table 2.3
function drawTable23(){

  var struct = [
    ["Fever Cases (T > 37.5 &#176;C)", "reg_4", "no_deaths"],
    ["Malaria confirmed by rapid test or slide", "epi_1"],
    ["Acute Respiratory Tract Infection", "icd_4177"],
    ["Acute watery diarrhoea", "icd_1"],
    ["Acute watery diarrhoea among those over five years of age", "epi_7", "highlight"],
    ["Sexually Transmitted Diseases other than HIV", "icd_321"],
    ["Tuberculosis", "icd_91"],
    ["Moderate malnutrition", "cmd_43"],
    ["Severe malnutrition", "icd_2189"],
    ["Other diseases of public health importance", "cmd_48"],
  ]

  $('.table23-wrapper').html( drawFromStruct(struct) );
}

//Draw table 3
function drawTable3(){

  html = "<table class='reports-table centered table table-hover table-condensed'>" +
    "<thead><th class='border-right'></th><th>Cases</th></thead>" +
    "<tr><td class='total'>Number of alerts generated</td><td>" + content.alerts.total + "</td></tr>" +
    "<tr><td class='total'>Number of alerts investigated</td><td>" + content.alerts.investigated + 
    "</td></tr></table>";  
  $('.table3-wrapper').html( html );
}

/*Refactorisation: draw table from a two dimensional array.
 *Takes an array of two or three element arrays, where:
 *    1st element - is the textual label or key for the row.
 *    2nd element - is the agg code for the row (both cases and deaths are shown)
 *    3rd element (optional) - is a string containing display options.
 *The resulting table is a three column table of key, cases and deaths. */
function drawFromStruct( struct ){

  html = "<table class='reports-table centered table table-hover table-condensed'>" +
    "<thead><th class='border-right'></th><th>Cases</th><th>Deaths</th>" +
    "<th class='total'>Total</th></thead>";

  for( var i=0; i<struct.length; i++ ){

    //If the "highlight no_deaths" option is sepcified in the third array element.
    if( struct[i][2] == "highlight no_deaths" ){

      var cases = content.epi_monitoring[struct[i][1]];

      html += "<tr><td class='highlight total right-align border-right'>" + struct[i][0] + "</td>" +
        "<td class='highlight' >" + cases + "</td>" +
        "<td class='highlight' > NA </td>" +
        "<td class='total highlight border-left'>" + cases + "</td></tr>"

    //If the "no_deaths" option is sepcified in the third array element.
    }else if( struct[i][2] == "no_deaths" ){

      var cases = content.epi_monitoring[struct[i][1]];

      html += "<tr><td class='total key'>" + struct[i][0] + "</td>" +
        "<td>" + cases + "</td>" +
        "<td>NA</td>" +
        "<td class='total'>" + cases + "</td></tr>"

    //If the "highlight" option is sepcified in the third array element.
    }else if( struct[i][2] == "highlight" ){

      var deaths = content.deaths[struct[i][1]];
      var cases = content.epi_monitoring[struct[i][1]];
      var total = deaths + cases;

      html += "<tr><td class='highlight total right-align border-right'>" + struct[i][0] + "</td>" +
        "<td class='highlight' >" + cases + "</td>" +
        "<td class='highlight' >" + deaths + "</td>" +
        "<td class='total highlight border-left'>" + total + "</td></tr>"

    //Otherwise, just draw a standard table row using the first two elements of the array.
    }else{

      var deaths = content.deaths[struct[i][1]];
      var cases = content.epi_monitoring[struct[i][1]];
      var total = deaths + cases;

      html += "<tr><td class='total key'>" + struct[i][0] + "</td>" +
        "<td>" + cases + "</td>" +
        "<td>" + deaths + "</td>" +
        "<td class='total'>" + total + "</td></tr>"
    } 
  }
    
  html += "</table>";
  return html
}
</script>
{% endblock extra_js %}

