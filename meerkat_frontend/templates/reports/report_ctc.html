{% extends 'reports/base.html' %}
{% block title %}{{report.data.project_region|e}} &middot; {{ _('Cholera Treatment Centre Report') }} &middot; {{ _('Week') }} {{ report.data.epi_week_num }}{% endblock title %}
{% block body %}

{% macro format_percent(input) %}
  {{ input.Y }} ({{ (input.Y / input.N * 100 )|int}} %)

{%- endmacro %}


{% set yesnodk = {"yes": "Yes", "no": "No", "dnk": "Don't Know", "blank": "Don't Know"} %}

<!-- CONTENT -->
<div class="page-header">
  <h2>
    <span
      class="flag-icon flag-icon-{{report.flag}}"
      style="background-image: url(/static/img/flags/4x3/{{report.flag}}.svg) !important;"
    >
    </span>
    <img class="moh-title-logo" src="/static/img/{{content['footer']['logos']['country_partner']}}">
    <span class="hidden-xs">{{_(report.data.project_region|e)}} &middot; </span>{{ _('CTC QUALITY AND OUTCOMES MONITORING') }}
    <span class="report-week">
        {{ report.data.start_date|datetime_from_json|datetime('dd MMMM YYYY') }} - {{ report.data.end_date|datetime_from_json|datetime('dd MMMM YYYY') }}
    </span>
  </h2>
</div>
<div class="row">
  <!-- HIGHLIGHTS -->
    <div class="col-sm-6">
     <div class="chart-wrapper infrastructure">
         <div class="chart-title">{{_('Infrastructure')}}</div>
	 <div class="chart-stage">
	     <table class="table small">
                 <tr> <td> {{_('Bed capacity:')}}  </td> <td>{{ format_percent(report.overview.ctc_beds_sufficient) }} sufficent capacity </td></tr>
               <tr> <td> {{_('Beds available:')}}  </td> <td> {{report.overview.get("ctc_beds", 0)|int}} </td></tr>
    	      <tr> <td> {{_('Patients in the CTC today:')}}  </td> <td> {{report.overview.get("ctc_patients", 0)|int}} </td></tr>
    	      <tr> <td> {{_('Doctors working in the CTC today:')}}  </td> <td> {{report.overview.get("ctc_doctors", 0)|int}} </td></tr>
              <tr> <td> {{_('Nurses working in the CTC today:')}}  </td> <td> {{report.overview.get("ctc_nurses", 0)|int}} </td></tr>
	     </table>
	 </div>
     </div>
     

     <div class="chart-wrapper case-management">
         <div class="chart-title">{{_('Case Management')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Case Management protocol available:')}}  </td> <td>{{ format_percent(report.overview.ctc_case_management_value) }} </td></tr>
                 <tr> <td> {{_('Training and Case Management taken place:')}}  </td> <td> {{ format_percent(report.overview.ctc_case_management_training)}}</td></tr>
                 <tr> <td> {{_('Oral Rehyration Salts (ORS) available:')}}  </td> <td> {{ format_percent(report.overview.ctc_case_management_ors)}} </td></tr>
                 <tr> <td> {{_('IV and Infusion Sets available:')}}  </td> <td> {{ format_percent(report.overview.ctc_case_management_iv)}} </td></tr>
                 <tr> <td> {{_('Antibiotics Available:')}}  </td> <td> {{ format_percent(report.overview.ctc_case_management_abx)}} </td></tr>
             </table>
         </div>
     </div>
     <div class="chart-wrapper infection-prevention">
         <div class="chart-title">{{_('Infection Prevention Control')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('IPC protocols available:')}}  </td> <td>  {{ format_percent(report.overview.ctc_ipc_value) }} </td></tr>
                 <tr> <td> {{_('Hand gloves, gowns and aprons available:')}}  </td> <td>  {{ format_percent(report.overview.ctc_ipc_apron)}} </td></tr>
             </table>
         </div>
     </div>


    </div>
    <div class="col-sm-6">
     <div class="chart-wrapper caseload">
	 <div class="chart-title clearfix">{{_('Caseload')}}</div>
	 <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Patients treated in the last week:')}}  </td> <td> {{report.overview.get("cases_last_week", 0)|int}}</td></tr>
		 <tr> <td> {{_('Children under five treated in the last week:')}}  </td> <td>{{report.overview.get("cases_u5_last_week", 0)|int}} </td></tr>
                 <tr> <td> {{_('Deaths recorded in the last week:')}}  </td> <td> {{report.overview.get("deaths_last_week", 0)|int}}</td></tr>
                 <tr> <td> {{_('Case fatality Rate:')}}  </td> <td> {{report.overview.cfr[0]|round(1)}} ( {{ report.overview.cfr[1]|round(1) }} - {{ report.overview.cfr[2]|round(1) }} )</td></tr>
             </table>
	 </div>
     </div>

     <div class="chart-wrapper water-sanitation">
         <div class="chart-title">{{_('Water and Sanitation')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Safe water protocols available:')}}  </td> <td> {{ format_percent(report.overview.ctc_wash_value)}} </td></tr>
                 <tr> <td> {{_('Latrine facilities available:')}}  </td> <td> {{ format_percent(report.overview.ctc_wash_lat)}} </td></tr>
                 <tr> <td> {{_('Water points available:')}}  </td> <td> {{ format_percent(report.overview.ctc_wash_wp)}} </td></tr>
                 <tr> <td> {{_('Hand soap available:')}}  </td> <td> {{ format_percent(report.overview.ctc_wash_soap)}} </td></tr>
                 <tr> <td> {{_('Safe water storage:')}}  </td> <td> {{ format_percent(report.overview.ctc_wash_safe_storage)}} </td></tr>
             </table>
         </div>
     </div>
     <div class="chart-wrapper laboratory">
         <div class="chart-title">{{_('Laboratory')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Laboratory protocols available:')}}  </td> <td> {{ format_percent(report.overview.ctc_lab_protocol_value)}} </td></tr>
                 <tr> <td> {{_('Cary Balir Transport medium available:')}}  </td> <td> {{ format_percent(report.overview.ctc_lab_transport)}} </td></tr>
                 <tr> <td> {{_('Specimen plated within 24 hours:')}}  </td> <td> {{ format_percent(report.overview.ctc_lab_24h)}} </td></tr>
             </table>
         </div>
     </div>
    </div>
</div>
<div class="row">
  <div class="col-sm-12">
      <div class="chart-wrapper cholera-chart">
          <div class="chart-title clearfix">{{_('Cholera Cases')}}</div>
          <div class="chart-stage">
              <div id="fig-1" class='chart'></div>
          </div>
      </div>
  </div>

  
</div>
<div class="row">
	<div class="col-sm-6">
		<div class="chart-wrapper country-map">
			<div class="chart-title clearfix">{{_('Map of Cholera Cases')}}</div>
		    <div class="chart-stage">
			<div id="cholera-map"  class="mapbox"></div>
		    </div>
		</div>
	</div>
    <div class="col-sm-6">
        <div class="chart-wrapper country-map">
            <div class="chart-title clearfix">{{_('Map of Surveyed Clinics')}}</div>
            <div class="chart-stage">
            <div id="surveyed-clinic-map"  class="mapbox"></div>
            </div>
        </div>
    </div>
</div>

{% for ctc in report.clinic_data %}
{% set dat = ctc.latest_data %}
{% if ctc.status == "Surveyed" %}
<div style='page-break-inside:avoid'>
<div class='row'>
    <div class='col-xs-12'>
        <div class='facility-title'>
            <div class='left-part'>
                <div class='facility-title-name title'>{{ ctc.name }}</div>
                <div class='facility-title-location'>
                {{ ctc.district }} | {{ ctc.region }} <br />
                    {{_('Latitude: ')}} {{ctc.gps[0]}}, {{_('Longitude: ')}} {{ctc.gps[1]}} <br />
                    {{_('Surevedy on') }} {{ctc.latest_date}}
                </div>
            </div>
            <div class='right-part'>
                <div class='facility-title-partner title'>
                    {{_('Partner: ')}} {{dat.ctc_partner if ctc.status == "Surveyed" else ""}}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
 <div class="col-sm-6">
     {% if ctc.status == "Surveyed" %}
     <div class="chart-wrapper infrastructure">
         <div class="chart-title">{{_('Infrastructure')}}</div>
	 <div class="chart-stage">
	     <table class="table small">
              <tr> <td> {{_('Beds available:')}}  </td> <td> {{ctc.latest_data.get("ctc_beds", 0)|int}} </td></tr>
    	      <tr> <td> {{_('Patients in the CTC today:')}}  </td> <td> {{ctc.latest_data.get("ctc_patients", 0)|int}} </td></tr>
    	      <tr> <td> {{_('Doctors working in the CTC today:')}}  </td> <td> {{ctc.latest_data.get("ctc_doctors", 0)|int}} </td></tr>
              <tr> <td> {{_('Nurses working in the CTC today:')}}  </td> <td> {{ctc.latest_data.get("ctc_nurses", 0)|int}} </td></tr>
	     </table>
	 </div>
     </div>
     
     <div class="chart-wrapper caseload">
	 <div class="chart-title clearfix">{{_('Caseload')}}</div>
	 <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Patients treated in the last week:')}}  </td> <td> {{ctc.latest_data.get("ctc_cases", 0)|int}}</td></tr>
		 <tr> <td> {{_('Children under five treated in the last week:')}}  </td> <td>{{ctc.latest_data.get("ctc_cases_u5", 0)|int}} </td></tr>
                 <tr> <td> {{_('Deaths recorded in the last week:')}}  </td> <td> {{ctc.latest_data.get("ctc_deaths", 0)|int}}</td></tr>
             </table>
	 </div>
     </div>
     <div class="chart-wrapper case-management">
         <div class="chart-title">{{_('Case Management')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Case Management protocol available:')}}  </td> <td>{{ yesnodk[dat.get("ctc_case_management_value", "blank")]}} </td></tr>
                 <tr> <td> {{_('Training and Case Management taken place:')}}  </td> <td> {{ yesnodk[dat.get("ctc_case_management_training", "blank")]}}</td></tr>
                 <tr> <td> {{_('Oral Rehyration Salts (ORS) available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_case_management_ors", "blank")]}} </td></tr>
                 <tr> <td> {{_('IV and Infusion Sets available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_case_management_iv", "blank")]}} </td></tr>
                 <tr> <td> {{_('Antibiotics Available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_case_management_abx", "blank")]}} </td></tr>
             </table>
         </div>
     </div>
     <div class="chart-wrapper infection-prevention">
         <div class="chart-title">{{_('Infection Prevention Control')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('IPC protocols available:')}}  </td> <td>  {{ yesnodk[dat.get("ctc_ipc_value", "blank")] }} </td></tr>
                 <tr> <td> {{_('Hand gloves, gowns and aprons available:')}}  </td> <td>  {{ yesnodk[dat.get("ctc_ipc_apron", "blank")]}} </td></tr>
             </table>
         </div>
     </div>
     <div class="chart-wrapper water-sanitation">
         <div class="chart-title">{{_('Water and Sanitation')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Safe water protocols available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_wash_value", "blank")]}} </td></tr>
                 <tr> <td> {{_('Latrine facilities available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_wash_lat", "blank")]}} </td></tr>
                 <tr> <td> {{_('Latrine type:')}}  </td> <td> {{report.variables.get(ctc.latest_categories.get("ctc_lat_type", None), {}).get("name", "")}} </td></tr>
                 <tr> <td> {{_('Water points available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_wash_wp", "blank")]}} </td></tr>
                 <tr> <td> {{_('Hand soap available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_wash_soap", "blank")]}} </td></tr>
                 <tr> <td> {{_('Safe water storage:')}}  </td> <td> {{ yesnodk[dat.get("ctc_wash_safe_storage", "blank")]}} </td></tr>
             </table>
         </div>
     </div>
     <div class="chart-wrapper laboratory">
         <div class="chart-title">{{_('Laboratory')}}</div>
         <div class="chart-stage">
             <table class="table small">
                 <tr> <td> {{_('Laboratory protocols available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_lab_protocol_value", "blank")]}} </td></tr>
                 <tr> <td> {{_('Cary Balir Transport medium available:')}}  </td> <td> {{ yesnodk[dat.get("ctc_lab_transport", "blank")]}} </td></tr>
                 <tr> <td> {{_('Specimen plated within 24 hours:')}}  </td> <td> {{ yesnodk[dat.get("ctc_lab_24h", "blank")]}} </td></tr>
             </table>
         </div>
     </div>
     {% else %}
     <div class="chart-wrapper never">
         <div class="chart-title">{{_('Information')}}</div>
         <div class="chart-stage">
             This facility has never been surveyed.
         </div>
     </div>
     {% endif %}
 </div>

 <div class="col-sm-6">
    {% if ctc.status == "Surveyed" %}
    <div class="chart-wrapper facility-image">
        <div class="chart-title clearfix">{{_('Facility Photo')}}</div>
        <div class="chart-stage">
            <img src="/en/s3_files/get?path={{ctc.latest_data.ctc_facility_photo}}" />
        </div>
    </div>
    {% endif %}

    <div class="chart-wrapper facility-map">
    <div class="chart-title clearfix">{{_('Facility Location')}}</div>
        <div class="chart-stage">
            <div id="map-{{ctc.name|slugify}}"  class="map"></div>
        </div>
    </div>

    {% if ctc.status == "Surveyed" %}
    <div class="chart-wrapper facility-recommendations">
        <div class="chart-title clearfix">{{_('Recommendations')}}</div>
        <div class="chart-stage">
            {% for rec in ctc.recommendations %}
            <p>{{loop.index}}. {{rec}}</p>
            {% endfor %}
        </div>
    </div>
    {% endif %}
 </div>
</div>
</div>

{% endif %}

{% endfor %}





<!-- MORE INFO AND CONTACT -->
<div class="row">
  <div class="col-sm-6">
    <div class="chart-wrapper">
      <div class="chart-title">{{ _('More Information') }}</div>
      <div class="chart-stage">
                    {{ _('<p>A program of public health surveillance is being implemented in %(clinic_num)s outpatient clinics in %(project_region)s, in partnership with WHO and Ministry of Health. The project introduces case-based, integrated disease surveillance of priority diseases, conditions and events.</p>
          <p>The clinician uses the system within the consultation, which introduces clinical-decision support as well as best practice prescribing guidance and real-time reporting of information. Information is made available within one hour via an online framework with automated generation of SMS and email alerts and support for mapping and reporting.</p>', clinic_num=report.data.global_clinic_num, project_region=_(report.data.project_region|e)) }}
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="chart-wrapper">
      <div class="chart-title">{{ _('Contact Information') }}</div>
      <div class="chart-stage">
        <address>
	  {{address|safe}}
        </address>
      </div>
    </div>
  </div>
</div>
</div>
<div id="map" style="display: hidden;"></div>
{% endblock body %}
{% block extra_js %}
<!-- JAVASCRIPT DATA FOR CHARTS -->
<script>
	i18n = get_translator("/static/translations/"+language+"/LC_MESSAGES/messages.json");
 // Measles

	var cholera_data = [{% for week, value in report.summary.cholera_cases_o5.weeks.items() %}{"week":"{{ week|safe }}", "over": {{ value|safe }}, "under": {{report.summary.cholera_cases_u5.weeks[week]}}} {% if not loop.last %},{% endif %}{% endfor %}];

	cholera_data.sort(function(a,b){
		return a.week - b.week;
	});

	var cholera = {
		categories: cholera_data.map( function(a){ return a.week}),
		series: [
			{ name: i18n.gettext('Under 5 yrs'), data: cholera_data.map( function(a){ return a.under}) },
			{ name: i18n.gettext('Over 5 yrs'), data: cholera_data.map( function(a){ return a.over}) }
		],
		labels: { yAxis: { text: i18n.gettext("# Cases") }, xAxis: { text: i18n.gettext("Epi Week") } }
	};

	$('#fig-1').highcharts(
		measlesBarChart(
			cholera.categories,
			cholera.series,
			cholera.labels
		)
	);
    var reg_data = {{extras.reg_data|safe}};
	regional_map(
		{{report.data.cholera_map|safe}},
		{{extras.map_centre}},
		reg_data,
		'cholera-map'
	);
    ctc_surveyed_clinics_map(
        {{report.data.surveyed_clinics_map.surveyed|safe}},
        {{report.data.surveyed_clinics_map.non_surveyed|safe}},
        'surveyed-clinic-map',
        {{extras.map_centre}}
    );

 {% for ctc in report.clinic_data %}
  {% if ctc.status == "Surveyed" %}
 ctc_point_map({{ctc.gps|safe}}, "map-{{ctc.name|slugify}}", {{extras.map_centre}})
 	var cholera_data = [{% for week, value in ctc.cases_o5_history.weeks.items() %}{"week":"{{ week|safe }}", "over": {{ value|safe }}, "under": {{ctc.cases_u5_history.weeks[week]}}} {% if not loop.last %},{% endif %}{% endfor %}];

	cholera_data.sort(function(a,b){
		return a.week - b.week;
	});

	var cholera = {
		categories: cholera_data.map( function(a){ return a.week}),
		series: [
			{ name: i18n.gettext('Under 5 yrs'), data: cholera_data.map( function(a){ return a.under}) },
			{ name: i18n.gettext('Over 5 yrs'), data: cholera_data.map( function(a){ return a.over}) }
		],
		labels: { yAxis: { text: i18n.gettext("# Cases") }, xAxis: { text: i18n.gettext("Epi Week") } }
	};

	$('#timeline-{{ctc.name|slugify}}').highcharts(
		measlesBarChart(
			cholera.categories,
			cholera.series,
			cholera.labels
		)
	);
 {% endif %}

 {% endfor %}


 </script>
{% endblock extra_js %}
