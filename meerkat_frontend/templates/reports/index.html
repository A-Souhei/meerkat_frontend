{% extends 'base.html' %}

{% block menu %}
<ul class="nav navbar-nav">
	<li><a href="/technical/" >Dashboard</a></li>
	<li class="active"><a href="/reports/" >Reports</a></li>
	<li><a href="/messaging/" >Notifications</a></li>
	<li><a href="/explore/" >Explore Data</a></li>
	<li><a href="/download/" >Download Data</a></li>
	<li><a href="/" >Log out</a></li>
</ul>
{% endblock %}

{% block body %}
<!-- CONTENT -->


<div class="container page-content">
	<div class="breaker"> </div>
	<div class="top-bar row">
		<div class="location-box box">
			<a href="#menu-toggle" id="menu-toggle" class="menu-toggle">
			<div class="location-box__label">
				<div>Location:</div>
				<div id="location-title" class="location-title" >Not Loaded</div>
			</div>
			<span class="glyphicon glyphicon-chevron-right"></span>
			<span class="glyphicon glyphicon-chevron-left hidden"></span>
			</a>
		</div>
		<div class="tab-title less-padding-col">
			Reports 
		</div>
		<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box ">
			Date not loaded.
		</div>
	</div>

	<div class="toggled" id="wrapper">

		<div id="sidebar-wrapper" >
			<div id="location-selector" class="location-selector">
				Locations not loaded
			</div>
		</div>

		<div id="page-content-wrapper">
			<div class="row">
				<div class="col-xs-12 less-padding-col">
					<div class="box">
						{{content.introduction}}
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12 col-sm-6 less-padding-col">
					<div class="box chartBox">
						<div class="chartBox__heading">Download the latest reports
						</div>
						<div class="chartBox__content reports-form" > 
							<div class="row">
								Download the latest reports published for your selected location: 
								<span class="location-name"></span>.
							</div>
							<div class="breaker"></div>
							{% for report in content.reports %}
								<div class="row download-buttons">
									<label class="col-xs-12 col-sm-5">{{report.name}}</label>
									<input class="btn btn-default btn-lg col-xs-5 col-sm-3 pull-right" value="PDF">
									<input class="btn btn-default btn-lg col-xs-5 col-sm-3 pull-right" value="HTML">
								</div>
							{% endfor %}
						</div>
					</div>
				</div>
				<div class="col-xs-12 col-sm-6 less-padding-col">
					<div class="box chartBox">
						<div class="chartBox__heading">Report Selector
						</div>
						<div class="chartBox__content " > 
							<form class="reports-form">
								<div class="title row">Choose which report to download:</div>
								<div class="row"><div id="report-selector" class="col-sm-offset-2"></div></div>
								<div class="title row">Choose which time period:</div>
								<div class="row">
									<div class="col-sm-offset-2">
										<label class="row"> End date: </label>
										<div class='input-group date col-sm-8 row' 
											 id='end-date' name='end_date' value=''>
											<input type='text' class="form-control "/>
											<span class="input-group-addon">
												<span class="glyphicon glyphicon-calendar"></span>
											</span>
										</div>
										<label class="row" > Start date: </label>
										<div class=row>
											<input type="radio" class="radio-button"/> 
											<div class="radio-label" > 
												Use all previously available data. 
											</div>
										</div>
										<div class=row>
											<input type="radio" class="radio-button" /> 
											<div class="radio-label"> 
												Only use data available after: 
											</div>
											<div class='input-group date col-sm-8 row' 
												 id='start-date' name='start_date' value=''>
												<input type='text' class="form-control "/>
												<span class="input-group-addon">
													<span class="glyphicon glyphicon-calendar"></span>
												</span>
											</div>
										</div>
									</div>
								</div>
								<div class="title row">Choose which location:</div>

								<div id="location" class="row">
									<div class="col-sm-offset-2 location-box box">
										<a href="#menu-toggle" id="menu-toggle" class="menu-toggle">
										<div class="location-box__label">
											<div>Location:</div>
											<div id="location-title" class="location-title">Not Loaded</div>
										</div>
										<span class="glyphicon glyphicon-chevron-right"></span>
										<span class="glyphicon glyphicon-chevron-left hidden"></span>
										</a>
									</div>
								</div>
								<div class="title row">Click to download your report:</div>
								<div class="col-sm-offset-2 download-buttons">
									<div class="col-sm-8 no-padding-col">
										<input class="btn btn-default btn-lg col-sm-5" value="HTML">
										<input class="btn btn-default btn-lg col-sm-5 pull-right" value="PDF">
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock body %}

{% block pageJS %}

<script type="text/javascript" >
  
$(".menu-toggle").click(function(e) {
	e.preventDefault();
	$("#wrapper").toggleClass("toggled");
	$(".location-box .glyphicon").toggleClass( "hidden" );
});

//Draw date/time pickers.
d = new Date();
$('#start-date').datetimepicker({
    useCurrent: false,
    defaultDate: moment.utc(d.getFullYear()+"-01-01 00:00:00 "),
    format: "DD/MM/YYYY",
});
$('#end-date').datetimepicker({
    useCurrent: true,
    defaultDate: d.toISOString(),
    format: "DD/MM/YYYY"
});


var config = {{content|tojson|safe}};
var api_root = "{{config['EXTERNAL_API_ROOT']}}";
var week = {{week.epi_week}};
loadLocationTree({locID:{{loc}}});

$("#epi-week-title").html( "Week "+get_epi_week() + " Â· " + get_date() );
drawReportSelect();


function drawReportSelect(){

	var html = "<select class='report col-sm-8 no-padding-col'>";

	for( var i in config.reports ){

		var report = config.reports[i];

		html += "<option value='" + report.url + "'>" + report.name +"</option>"

	}

	html += "</select>";

	$('#report-selector').html( html );
	
}

function selectYear(year, reportID){

	var html = "";

	if( year == config.start_dates[reportID].year ){

		for( var k = config.start_dates[reportID].week; k < 52-report.number ; k++ ){
			html += '<option value=' + k + '>Week ' + k + '</option>';
		}

	}else if( year == new Date().getFullYear() ){
		//report.number specifies how many reports to include quick links for each year.
		for( var k = get_epi_week()-report.number-1; k > 0; k-- ){
			html += '<option value=' + k + '>Week ' + k + '</option>';
		}
	}else{
		for( var k = 1; k <52-report.number; k++ ){
			html += '<option value=' + k + '>Week ' + k + '</option>';
		}
	}
	
	$( '#' + reportID + '-week-selector' ).html(html);

}

//This method updates aspects of the page based upon the users input.
//All three arguments can be left undefined if necessary - all reports will update with current locID and year.
function drawCharts(locID, year, reports){

	//locID (the id of the location) is an optional argument.  
	//If it isn't set, look at the current page state locID, if that isn't set, default to 1.
	if( typeof locID == 'undefined' ){
		if( history.state === null || typeof history.state.locID == 'undefined' ) locID = 1;
		else locID = history.state.locID;
	}

	//Load the location data from the locations tree.
	var node = locations.first( {strategy: 'breadth'}, function(x){ return x.model.id===locID; });

	console.log( node );

	$('.location-name').html(node.model.text);

	if( typeof reports == 'undefined' ){
		reports = [];
		for( var j=0; j<config.reports.length; j++ ) reports[j] = j;
	}else if( typeof reports == 'number' ){
		reports = [reports];
	}

	//Draw the report selection table for all desired reports.
	for( var i=0; i<reports.length; i++ ){

		var report = config.reports[reports[i]];
		var reportID = report.name.toLowerCase().split(' ').join('_');

		//Specify variables that characterise when reports are available from and to.
		var currentYear = new Date().getFullYear();
		var startYear = report.start_date.year;
		var year = year ? year : new Date().getFullYear();

		var currentWeek = get_epi_week()-1;
		var firstWeek = (year == startYear) ? report.start_date.week : 1;
		var lastWeek = (year == currentYear) ? currentWeek : 52;

		//Draw the year selector.
		var yearHtml = '<div class="pull-right">Year: <select id="' + reportID + '-year-selector">';
		for( var j =startYear; j<=currentYear; j++ ){
			yearHtml  += '<option value="' + j +'" ';
			if( j == year ) yearHtml += 'selected="selected"';
			yearHtml  += 'onclick="drawCharts(undefined,' + j + ',\'' + reports[i] + '\')">'+j+'</option>';
		}
		yearHtml  += '</select></div>';

		var html = '<table class="table table-hover table-condensed">';
		html += '<tr><th colspan="3">Location: ' + node.model.text + ' '+yearHtml+'</th></tr>';

		//If the week selection box has only one option, we don't want it to be shown as a selection box.
		//In this case increase the number of quick linked reports so that the final report is a quick link.
		//This will also automatically result in the week selection box not being drawn.
		if( lastWeek-firstWeek == report.number ) report.number++; 

		//Create a number of auto links for the previous n weeks (specified in the config file.
		for( var j=0; j<report.number; j++ ){
			
			var week = lastWeek - j;

			if( week > 0 ){
				html += '<tr><td class="indent" >Week '+ week + '</td>';
				html += '<td><a href="' + report.url + '/' + locID + '/' + year + '/' + week +
						'" target="_blank">HTML Report</a></td>';
				html += '<td><a href="' + report.url + '-' + locID + '-' + year + '-' + week +
						'.pdf" target="_blank">PDF Report</a></td></tr>';
			}
		}

		if( lastWeek-report.number >= firstWeek ){

			//Then create a selector that allows you to select any week you like. 
			html += '<tr><td><select id="' + reportID + '-week-selector">';
			//report.number specifies how many reports to include quick links for each year.
			for( var k = lastWeek-report.number; k >= firstWeek; k-- ){
				html += '<option value=' + k + '>Week ' + k + '</option>';
			}

			html += '</select></td>';
		
			var url = report.url + '/' + locID + '/' + year + '/';

			//Make the html link pick up the selected week from the selector.
			html += '<td><a href="" onclick="window.open(\'' + url + '\' + $(\'#' + reportID + 
					 '-week-selector\').val(), \'_blank\');return false;">HTML Report</a></td>';
			html += '<td><a href="' + report.url + '_' + locID + '_' + year + '_' + week +
						'.pdf" target="_blank">PDF Report</a></td></tr>';
		}else{
			html += '<tr><td colspan=3>No other reports have been generated for this year.</td></tr>';
		}

		html += '</table>';

		//DRAW the week selector table!
		$( '#' + reportID + "-table" ).html( html );

	}
}

</script>

{% endblock pageJS %}
