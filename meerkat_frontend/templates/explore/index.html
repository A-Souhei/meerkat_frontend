{% extends 'base.html' %}

{% block menu %}
<ul class="nav navbar-nav">
	<li><a href="/technical/" >Dashboard</a></li>
	<li><a href="/reports/" >Reports</a></li>
	<li><a href="/messaging/" >Notifications</a></li>
	<li class="active"><a href="/explore/" >Explore Data</a></li>
	<li><a href="/download/" >Download Data</a></li>
	<li><a href="/" >Log out</a></li>
</ul>
{% endblock %}

{% block body %}
<!-- CONTENT -->
<div class="container page-content">
	<div class="top-bar row">
		<div class="tab-title less-padding-col">
			Explore Data 
		</div>
		<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box ">
			Date not loaded.
		</div>
	</div>
	<div id="page-content-wrapper">
		<div class="row">
			<div class="col-xs-12 less-padding-col exploreChart" >
				<div class="row">		
					<div class="box cornerBox" >
						<span class="glyphicon glyphicon-transfer" id="transpose-button" 
						      onclick="callTranspose();" title="Flip axis" >
						</span>
					</div>

					<div class="box xaxis" >
						<div class="axis-selector">
						</div>
						<div class="options">
							<span class="glyphicon glyphicon-resize-small chart-option" id="strip-button"
							      onClick="callStrip();" title="Hide/show empty records" 
							      value="" name="strip">
							</span>
							<span class="glyphicon glyphicon-pencil chart-option" id="colour-button"
							      onClick="callColour();" title="Colour the table" 
							      value=true name="colour">
							</span>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="box yaxis" >
						<div class="axis-selector">
						</div>
					</div>
					<div class="box chartBox" >
						<div class="table-responsive" > </div>
					</div>
				</div>
				<div class="row">
					<div class="box timeline" >
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock body %}

{% block footer %}
<div class="container">
	<div class="footer__label pull-left col-xs-12 col-sm-6 col-md-5 less-padding-col">
		<p class="footer__title">Meerkat Health Surveillance</p>
		<p>Working with our partners:</p> 
		<ul class="footer__supporters" >
			{% for partner in content.footer.partners %}
				<li>{{partner}}</li>
			{% endfor %} 
		</ul>
		<p>For more information, please e-mail: {{content.footer.email|safe}} </p>
	</div>
	<div class="footer__logos pull-right col-xs-12 col-sm-6 col-md-7 less-padding-col">
		<img src="{{ url_for('static', filename='img/homepage/' + content.footer.logos.who) }}" id="whoLogo" ></img> 
		<img src="{{ url_for('static', filename='img/homepage/' + content.footer.logos.country_partner) }}"
				 id="countryLogo" ></img> 
		{% for logo in content.footer.logos.partners %}
			<img src="{{ url_for('static', filename='img/homepage/' + logo) }}" ></img> 
		{% endfor %} 
	</div>
</div>
{% endblock footer %}

{% block pageJS %}

<script type="text/javascript" >

var config = {{content|tojson|safe}};
var api_root = "{{config['EXTERNAL_API_ROOT']}}";
var week = {{week.epi_week}};

$("#epi-week-title").html( "Week " + get_epi_week() + " Â· " + get_date() );

$.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
	options.data = $.param($.extend(originalOptions.data, { api_key: config.api_key })) // 
});

//Draw axis category selectors.
var axisSelector = "<select>"
for( var i in config.categories ){
	var cat = config.categories[i];
	axisSelector += "<option value='" + cat[0] + "'>" + cat[1] + "</option>";
}
axisSelector += "</select>";
$('.axis-selector').html(axisSelector);

//Set a default table.
$('.xaxis .axis-selector option[value="age"]').attr('selected',true);
$('.yaxis .axis-selector option[value="cd_tab"]').attr('selected',true);
reDraw();

//Add a listener to the axis selectors, update table upon change.
$('.axis-selector').change( function(){
	reDraw();
});

//The chart state is stored in the html page - specifically '.chart-option' elements.
//Each of these elements should have a name and a value attribute.
//This function draws a new chart based upon these attributes.
function reDraw( ){

	var options = {};

	//Assemble correct options object from html elements.
	$('.chart-option').each( function(){
		options[$(this).attr('name')] = $(this).attr('value');
	});

	//Draw new chart
	createCrossPlot( $('.xaxis .axis-selector select').val(), 
	                 $('.yaxis .axis-selector select').val(), 
	                 options );

}

//Function that updates the colour option value.
function callColour(){
	var value = $('#colour-button').attr("value");
	$('#colour-button').attr("value", value=="true" ? "false" : "true" );
	reDraw();
}

//Function that updates the strip-empty-records option value. 
function callStrip(){

	var value = $('#strip-button').attr("value");

	if( value == "" ){
		$('#strip-button').attr("value","xy");
		$('#strip-button' ).addClass('glyphicon-resize-full');
		$('#strip-button' ).removeClass('glyphicon-resize-small');
	}else{
		$('#strip-button').attr("value","");
		$('#strip-button' ).addClass('glyphicon-resize-small');
		$('#strip-button' ).removeClass('glyphicon-resize-full');
	}

	reDraw();

}

//Function that transposes the data table.
function callTranspose(){

	var x = $('.xaxis .axis-selector select').val();
	var y = $('.yaxis .axis-selector select').val();

	$('.yaxis .axis-selector select').val(x);
	$('.xaxis .axis-selector select').val(y);

	reDraw();

}

</script>

{% endblock pageJS %}
