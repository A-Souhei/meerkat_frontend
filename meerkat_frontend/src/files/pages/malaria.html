<div class="top-bar row">

	<div class="location-box box">
		<a href="#menu-toggle" id="menu-toggle">
			<div class="location-box__label">
				<div id="location_box"></div>
				<div id="location-title" class="location-title"></div>
			</div>
			<span class="glyphicon glyphicon-chevron-right"></span>
			<span class="glyphicon glyphicon-chevron-left hidden"></span>
		</a>
	</div>
	<div class="less-padding-col tab-title hidden-xs col-sm-5 col-md-5" id="title">
	</div>
	<div id="epi-week-title" class="col-xs-12 col-sm-12 col-md-3 pull-right box ">
	</div>

</div>
<div class="malaria toggled" id="wrapper">

	<div id="sidebar-wrapper" >
		<div id="location-selector" class="location-selector">
		</div>
	</div>

	<div id="page-content-wrapper">
		<div class="row">
			<div class="col-xs-12 less-padding-col">
				<div class="chartBox box">
					<div class="chartBox__heading">
                        <p id="box_heading"></p>
                        <div class="box__type-selector pull-right">
                            <button onclick="selectChartType('charts');" id="malaria-charts" class='btn malaria-charts'>
                            </button> /
                            <button onclick="selectChartType('maps');" id="malaria-maps" class='btn malaria-maps'>
                            </button>
                        </div>
					</div>
					<div class="chartBox__content row">
                        <div class='col-xs-12 col-md-3'>
                            <div class='indicator-selector'>
                                <span class='glyphicon glyphicon-chevron-down' onclick="$('.indicator-selector .indicator').toggleClass('show');"></span>
                            </div>
                        </div>
                        <div class='col-xs-12 col-md-9'>
                            <div class='indicator-charts'>
                            </div>
                            <div class='indicator-maps'>
                            </div>
                        </div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="breaker"></div>

<!-- Menu Toggle Script -->
<script>

// We need to be able to translate the contents of the html page.
// Text is inserted here using the javascript translator.
$("#location_box").html(i18n.gettext("Location:"));
$("#location_title").html(i18n.gettext("Not Loaded"));
$("#title").html(i18n.gettext('Malaria'));
$("#epi-week-title").html(i18n.gettext('Date not loaded.'));
$("#location-selector").html(i18n.gettext('Locations not loaded'));
$("#box_heading").html(i18n.gettext('Indicators'));
$('#malaria-maps').html(i18n.gettext('Maps'));
$('#malaria-charts').html(i18n.gettext('Charts'));
$("#epi-week-title").html(i18n.gettext("Week")+" "+get_epi_week() + " Â· " + get_date());

// This code expands and shrinks the locations selector.
$("#menu-toggle").click(function(e) {
    e.preventDefault();
	$("#wrapper").toggleClass("toggled");
	$(".location-box .glyphicon").toggleClass("hidden");
	//Hack to resize highcharts upon side bar toggle. Call window resize() upon transition finish.
	var transitionEvent = whichTransitionEvent();
	transitionEvent && document.getElementById('sidebar-wrapper').addEventListener(transitionEvent, function() {
		$(window).resize();
	});
});

function prep(data){
        var output = [];
        var keys = Object.keys(data.timeline);
        for(var k in keys) output.push([new Date(keys[k]), data.timeline[keys[k]]]);
        return output;
}

function prep_map(data, locationInfo){
    var dataLocations = Object.keys(data);
    var output = {};
    for(var l in dataLocations){
        var locationID = dataLocations[l];
        if(parseInt(locationID)){
            output[locationInfo[locationID].name]={'value': data[locationID].current};
        }
    }
    return output;
}

var indicators =  [{
        name: i18n.gettext("Number of Cases"),
        id: "malaria-cases",
        drawChart: function(id, locID, locationInfo, districtShapes){
            var deferreds = [
                $.getJSON(api_root+'/indicators/n/cmd_17/'+locID, function(data){confirmed=prep(data);}),
                $.getJSON(api_root+'/indicators/n/cmd_29/'+locID, function(data){unconfirmed=prep(data);}),
                $.getJSON(api_root+'/indicators/n/cmd_17/'+locID+'?group_by_level=district', function(data){confirmedMap=data;}),
            ];
            $.when.apply($, deferreds).then(function(){
                $('.indicator-charts').append("<div class='chart show " + id + "' id='" + id + "-chart'></div>");
                Highcharts.chart(id+'-chart', {
                    chart: {type: 'spline'},
                    title:{text: undefined},
                    plotOptions: {spline: {marker: {enabled: false}}},
                    xAxis: {title: {text: i18n.gettext('Week')}},
                    yAxis: {title: {text: i18n.gettext('Cases')}},
                    series: [{
                        name: i18n.gettext('Confirmed Cases'),
                        data: confirmed
                    }, {
                        name: i18n.gettext('Unconfirmed Cases'),
                        data: unconfirmed
                    }]
                });
                $('.indicator-maps').append("<div class='map show " + id + "' id='" + id + "-map'></div>");
                var mappedData = prep_map(confirmedMap, locationInfo);
                var mapCenter = [config.map.center.lat, config.map.center.lng, config.map.zoom];
                regional_map(mappedData, mapCenter, districtShapes, id+'-map');
            });
        }
    },{
        name: i18n.gettext("% RDT for fever cases"),
        id: "malaria-rdt",
        drawChart: function(id, locID, locationInfo, districtShapes){
            var deferreds = [
                $.getJSON(api_root+'/indicators/n,d,m/mls_3,mls_2,100/'+locID, function(data){rdt=prep(data);}),
                $.getJSON(api_root+'/indicators/n,d,m/mls_3,mls_2,100/'+locID+'?group_by_level=district', function(data){rdtMap=data;})
            ];
            $.when.apply($, deferreds).then(function(){
                $('.indicator-charts').append("<div class='chart " + id + "' id='" + id + "-chart'></div>");
                Highcharts.chart(id+'-chart', {
                    chart: {type: 'spline'},
                    title:{text: undefined},
                    plotOptions: {spline: {marker: {enabled: false}}},
                    xAxis: {title: {text: i18n.gettext('Week')}},
                    yAxis: {title: {text: i18n.gettext('% fever cases tested')}},
                    series: [{
                        name: i18n.gettext('% RDT for fever cases'),
                        data: rdt
                    }]
                });
                $('.indicator-maps').append("<div class='map " + id + "' id='" + id + "-map'></div>");
                //var mappedData = prep_map(rdtMap, locationInfo);
                var mapCenter = [config.map.center.lat, config.map.center.lng, config.map.zoom];
                regional_map({}, mapCenter, districtShapes, id+'-map');
            });
        }
    },{
        name: i18n.gettext("% ACT for malaria cases"),
        id: "malaria-act",
        drawChart: function(id, locID, locationInfo, districtShapes){
            var deferreds = [
                $.getJSON(api_root+'/indicators/n,d,m/mls_48,cmd_17,100/'+locID, function(data){act=prep(data);}),
                $.getJSON(api_root+'/indicators/n,d,m/mls_48,cmd_17,100/'+locID+'?group_by_level=district', function(data){actMap=data;})
            ];
            $.when.apply($, deferreds).then(function(){
                $('.indicator-charts').append("<div class='chart " + id + "' id='" + id + "-chart'></div>");
                Highcharts.chart(id+'-chart', {
                    chart: {type: 'spline'},
                    title:{text: undefined},
                    plotOptions: {spline: {marker: {enabled: false}}},
                    xAxis: {title: {text: i18n.gettext('Week')}},
                    yAxis: {title: {text: i18n.gettext('% Malaria cases treated')}},
                    series: [{
                        name: i18n.gettext('% ACT Treatments for Malaria cases'),
                        data: act
                    }]
                });
                $('.indicator-maps').append("<div class='map " + id + "' id='" + id + "-map'></div>");
                var mappedData = prep_map(actMap, locationInfo);
                var mapCenter = [config.map.center.lat, config.map.center.lng, config.map.zoom];
                regional_map(mappedData, mapCenter, districtShapes, id+'-map');
            });
        }
    }
]

function selectIndicator(id){
    $('.indicator-selector .indicator').removeClass('selected');
    $('.indicator-selector .'+id).addClass('selected');
    $('.indicator-charts .chart').removeClass('selected show');
    $('.indicator-charts .'+id).addClass('selected show');
    $('.indicator-maps .map').removeClass('selected show');
    $('.indicator-maps .'+id).addClass('selected show');
    $('.indicator-maps .'+id).trigger('resizeMap');
    $(window).resize();

}

function selectChartType(type){
    switch (type) {
        case 'charts':
            $('.box__type-selector .btn').removeClass('selected');
            $('.box__type-selector .malaria-charts').addClass('selected');
            $('.indicator-charts').addClass('show');
            $('.indicator-maps').removeClass('show');
            break;
        case 'maps':
            $('.box__type-selector .btn').removeClass('selected');
            $('.box__type-selector .malaria-maps').addClass('selected');
            $('.indicator-charts').removeClass('show');
            $('.indicator-maps').addClass('show');
            $('.indicator-maps').children().trigger('resizeMap');
            break;
    }
    $(window).resize();
}
selectChartType('charts');

//This function is called every time a new location is loaded.
//Any location-dependant content should be redrawn through this function.
function drawCharts(locID){
    var deferreds = [
        $.getJSON(api_root+'/geo_shapes/district', function(data){districtShapes=data;}),
        $.getJSON(api_root+'/locations', function(data){locationInfo=data;})
    ];
    $.when.apply($, deferreds).then(function(){
        for(var i in indicators){
            $('.indicator-selector').append(
                "<div class='indicator "  + indicators[i].id +
                "' onclick='selectIndicator(\"" + indicators[i].id + "\");'>" +
                indicators[i].name + "</div>"
            );
            indicators[i].drawChart(indicators[i].id, locID, locationInfo, districtShapes);
        }
        console.log('flag');
        selectIndicator(indicators[0].id);
    });
}

</script>
