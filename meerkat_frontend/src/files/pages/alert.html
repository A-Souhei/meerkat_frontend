<div class="top-bar row">
	<div class="location-box box">
		<a href="" onclick="loadTab('alerts'); return false;">
			<span class="glyphicon glyphicon-chevron-left"></span>
			<div id="title"></div>
		</a>
	</div>
	<div class="tab-title hidden-xs col-sm-5 col-md-6">
		<div id="subtitle"></div><span id="alertTitle"></span>
	</div>
	<div id="epi-week-title" class="col-xs-12 col-sm-4 col-md-3 pull-right box " >

	</div>

</div>

<div class="disease">

	<div id="page-content-wrapper">
		<div class="row">
			<div class="col-xs-12 less-padding-col">
				<div class="chartBox box">
					<div class="chartBox__heading" id="box_heading">

					</div>
					<div class="chartBox__content">
						<table class="alert col-sm-6 col-xs-12">
							<tr>
								<td align="right" class="fit" ><b id="alert"></b></td> 
								<td><span id="alertID" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="case"></b></td>
								<td><span id="reason" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="type"></b></td>
								<td><span id="type_info" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="date_title"></b></td>
								<td><span id="date" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="clinic_title"></b></td>
								<td><span id="clinic" class="alertInfo" ></span> </td>
							</tr>
							<tr class="spaceUnder">
								<td align="right" class="fit" >
									<b><span class="glossary capitalised" word="region" id="region_title"></span>:</b>
								</td>
								<td><span id="region" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="patient_title"></b></td>
								<td><span id="patientID" class="alertInfo" ></span> </td>
							</tr>
							<tr>
								<td align="right" class="fit" ><b id="patient_age_title"></b></td>
								<td><span id="patientAge" class="alertInfo" ></span> </td>
							</tr>
							<tr class="spaceUnder">
								<td align="right" class="fit" ><b id="patient_gender_title"</b></td>
								<td><span id="patientGender" class="alertInfo" ></span> </td>
							</tr>
						</table>
						<div class="col-sm-6 col-xs-12" >
							<p><b id="investigation_title"></b></p>
							<div id="checklist"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</div>
<div class="breaker"></div>

<script>


function drawAlertContent( alertID ){

	 $("#title").html(i18n.gettext('Alerts'));
	 $("#sub_title").html(i18n.gettext('Alert #'));
	 $("#epi-week-title").html(i18n.gettext('Date not loaded.'));
	 $("#epi-week-title").html( "Week "+get_epi_week() + " Â· " + get_date() );
	 $("#box_heading").html(i18n.gettext('Alert Investigation Report'));
	 $("#alert").html(i18n.gettext('Alert:'));
	 $("#case").html(i18n.gettext('Case:'));
	 $("#type").html(i18n.gettext('Type:'));
	 $("#date_title").html(i18n.gettext('Date:'));
	 $("#clinic_title").html(i18n.gettext('Clinic:'));
	 $("#region_title").html(i18n.gettext('Region:'));
	 $("#patient_title").html(i18n.gettext('Patient ID:'));
	 $("#patient_age_title").html(i18n.gettext('Patient Age:'));
	 $("#patient_gender_title").html(i18n.gettext('Patient Gender:'));
	 $("#investigation_title").html(i18n.gettext('Alert Investigation:'));
	 $(".alertInfo").each(function(){
		 $(this).html(i18n.gettext('No data loaded'));
	 }
	 );
	 
	 $.getJSON( api_root+"/alert/"+alertID, function( alert ){
         $.getJSON( api_root+"/variables/cd_tab", function( variables ){
			 //Load the location info for the given location ID from the location tree.
																					   var node = locations.first( {strategy: 'breadth'}, function(x){ return x.model.id===alert.alert.clinic; });
			 var parent = node.getPath();
			 parent = parent[parent.length-2];
			 
			 //Assemble the alert investigation checklist as a table.
			 var stages = ["Referral", "Case Management", "Contact Tracing", "Laboratory Diagnosis" ];
			 var stage_ids = ["ale_5", "ale_6", "ale_7", "ale_8"]
			 var table = "<table>";
			 
			 for( var i in stages ){
				 
			var stage = stages[i];

			table += "<tr><td align='right' class='fit' ><b>" + i18n.gettext(stage) + "</b></td>";

			if( "ale_1" in alert.alert.variables && stage_ids[i] in alert.alert.variables ){
				table += "<td>"+ i18n.gettext('Completed') +" </td>";
			}else{
				table += "<td>"+ i18n.gettext('Not Completed') + "</td></tr>";
			}			
		}

		table += "</table>";
		
		//Draw!
		$('#alertTitle').html( alertID );
		$('#alertID').html( alertID );
			 $('#reason').html( variables[alert.alert.variables.alert_reason].name );
		$('#date').html( alert.alert.date.split("T")[0] );
	    $('#clinic').html( node.model.text );
			 $('#region').html( parent.model.text );
			 console.log(alert);
    	 if (alert.alert.variables.alert_type == "individual") {
		     $('#type_info').html(i18n.gettext("Individual"));
			 $('#patientID').html( alert.alert.uuid );
			 $('#patientAge').html( alert.alert.variables.alert_age );
			 $('#patientGender').html( i18n.gettext(alert.alert.variables.alert_gender ));
		 }else if (alert.alert.variables.alert_type == "threshold"){

			 if(alert.alert.variables.alert_duration == 1){
				 $('#type_info').html(i18n.gettext("Daily Threshold"));
			 }else if(alert.alert.variables.alert_duration == 7){
				 $('#type_info').html(i18n.gettext("Weekly Threshold"));
			 }
			ids = [alert.alert.uuid]
			ages = [alert.alert.variables.alert_age]
			genders = [alert.alert.variables.alert_gender]
			for(a in alert.linked_alerts){
				ids.push(alert.linked_alerts[a].uuid)
				ages.push(alert.linked_alerts[a].variables.alert_age)
				genders.push(alert.linked_alerts[a].variables.alert_gender)
			}
			$("#patient_title").html(i18n.gettext('Patient IDs:'));
			$("#patient_age_title").html(i18n.gettext('Patient Ages:'));
			$("#patient_gender_title").html(i18n.gettext('Patient Genders:'));
			$('#patientID').html( ids.join("<br />") );
			$('#patientAge').html( ages.join());
			$('#patientGender').html( genders.join());
		}
		$('#checklist').html( table );		
		
         });
      });

}
</script>
